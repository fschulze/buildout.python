define cfg
[buildout]
extends =
    src/base.cfg
    src/readline.cfg
    src/zlib.cfg
    src/$(buildout_target).cfg
python-buildout-root = $${buildout:directory}/src
parts =
    $${buildout:base-parts}
    $${buildout:readline-parts}
    $${buildout:zlib-parts}
    $${buildout:$(buildout_target)-parts}
endef
export cfg

all: .installed.cfg

test.cfg:
	test -e $@ || echo "$$cfg" > $@

get-pip.py:
	curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py

virtualenv/bin/virtualenv: get-pip.py
	python get-pip.py --isolated -I --prefix virtualenv virtualenv
	export PYTHONPATH=$(shell ls -d $$(pwd)/virtualenv/lib/*/site-packages); env | grep PYTHON

bin/pip: virtualenv/bin/virtualenv
	export PYTHONPATH=$(shell ls -d $$(pwd)/virtualenv/lib/*/site-packages); virtualenv/bin/virtualenv .

bin/buildout: bin/pip
	bin/pip install setuptools==33.1.1 zc.buildout==1.4.4

.installed.cfg: test.cfg bin/buildout
	bin/buildout -vc test.cfg
